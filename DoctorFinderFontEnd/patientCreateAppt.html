<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book an Appointment</title>
    <script src="daypilot-all.min.js"></script>
    <link type="text/css" rel="stylesheet" href="calendar_g.css" />
    <link type="text/css" rel="Stylesheet" href="./CSS/patientCreateAppt.css">
</head>

<body onload="getLoggedInPatient()">

    <div class="container">
        <div class="container">
            <h1 id="header"></h1>
        </div>
        <h1>Book an Appointment now!</h1>

        <h3>Please select a specialty</h3>
        <select id="specialty" onchange="loadCalendar(), loadNav()">
            <option value="5">Cardiologist</option>
            <option value="1">Dermatologist</option>
            <option value="8">Endocrinologist</option>
            <option value="4">Family Physician</option>
            <option value="9">Infectious Disease Physician</option>
            <option value="11">Necromancer</option>
            <option value="10">Neurologist</option>
            <option value="6">Obstetrician/Gynecologist</option>
            <option value="2">Orthepedic</option>
            <option value="3">Pediatrician</option>
            <option value="7">Psychiatrist</option>
        </select>

        <div class="main" style="display: flex;">
            <div style="margin-right: 10px;">
                <div id="nav"></div>
            </div>
            <div style="flex-grow: 1">
                <div id="dp"></div>
            </div>
        </div>

        <div id="myModal" class="modal">

            <!-- Modal content -->
            <div class="modal-content">
                <span class="close">&times;</span>
                <h5 id="confirmation"></h5>
                <input id="reason" type="text" required placeholder="Please state your reason for visit">
                <button id="confirmAppt" onclick="bookPatientAppt()">Book Appointment</button>
            </div>

        </div>


    </div>


</body>

<script>

    dp;

    var modal = document.getElementById("myModal");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {
        modal.style.display = "none";
    }
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }


    function loadNav() {
        var nav = new DayPilot.Navigator("nav");
        nav.showMonths = 3;
        nav.skipMonths = 3;
        nav.selectMode = "week";
        nav.onTimeRangeSelected = function (args) {
            dp.startDate = args.day;
            dp.update();
            dp.events.load("http://localhost:8080/availabiltyBySpecialty/" + paramsId);
            //loadAppts();
        };
        nav.init();
    }

    function loadCalendar() {

        let specialtySearch = document.getElementById("specialty").value;

        dp = new DayPilot.Calendar("dp");
        dp.viewType = "Week";
        dp.startDate = "2021-02-14";
        //dp.theme = "calendar_g";
        dp.init();

        dp.eventsLoadMethod = "GET";
        dp.eventMoveHandling = "disabled";

        dp.onEventClicked = function (args) {

            dp.events.list.forEach(element => {
                if (element.id == args.e.id()) {
                    a = element;
                    console.log(a);
                }

            });
            modalDisplay();
        }

        dp.events.load("http://localhost:8080/availabiltyBySpecialty/" + specialtySearch);
        //loadAvails();
        //loadAppts();

    }

    function modalDisplay() {
        modal.style.display = "block";
    }

    function bookPatientAppt() {

        let reason = document.getElementById("reason").value;

        let appointment = {
            start: a.start,
            end: a.end,
            docId: a.doctorId,
            patientId: patient,
            text: reason,
        }

        let xhttp = new XMLHttpRequest();

        xhttp.onreadystatechange = function () {

            if (this.readyState == 4 && this.status == 200) {
                console.log(this.responseText);
                confirmationAppt = JSON.parse(this.responseText);
                console.log(confirmationAppt);

                document.getElementById("confirmation").innerHTML = "Appointment Confirmed!";
                setTimeout(() => {
                    window.location.href = `./patientDashboard.html?id=${patient.patientId}`;
                }, 3000);

            }
        }

        xhttp.open("POST", "http://localhost:8080/bookAppointment?id=" + a.id, true);
        xhttp.setRequestHeader("Content-type", "application/json");
        xhttp.send(JSON.stringify(appointment));

        //alert("clicked: " + args.e.id());
    }

    function getLoggedInPatient() {

        let xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                console.log(this.responseText);
                patient = JSON.parse(this.responseText);
                console.log(patient);
                patId = patient.patientId;
                console.log("patId: " + patId);


                let welcomeHeader = `<div class="container"><h1>Welcome ${patient.firstName}!</h1></div>
            <div class="container">
            <h3>Here is your Information</h3><br>
            </div>`

                document.getElementById("header").innerHTML = welcomeHeader;

            }
        }
        // getting the whole queryurl
        let parameter = window.location.search;
        // splitting the parameters from the querystring
        let urlparam = new URLSearchParams(parameter);
        // getting the id from the queryurl
        paramsId = urlparam.get("id");

        xhttp.open("GET", "http://localhost:8080/loggedInPatient?id=" + paramsId, true);
        xhttp.send();
    }



</script>

</html>